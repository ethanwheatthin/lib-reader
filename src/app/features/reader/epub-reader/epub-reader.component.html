<div class="epub-container" [attr.data-theme]="theme()" [class.focus-mode]="focusMode()">
  <!-- Reading progress bar -->
  <app-reading-progress 
    [progress]="readingProgress$ | async" 
    [theme]="theme()"
    [class.hidden-in-focus]="focusMode()">
  </app-reading-progress>

  <!-- Unified settings panel -->
  <app-unified-settings-panel
    [isOpen]="panelOpen()"
    [theme]="theme()"
    [settings]="currentSettings"
    [chapters]="chapters()"
    [currentChapter]="currentChapterHref()"
    [bookmarks]="(bookmarks$ | async) ?? []"
    [readingStats]="(readingStats$ | async) ?? null"
    [readingGoal]="(readingGoal$ | async) ?? null"
    [todayReadingTime]="(todayReadingTime$ | async) ?? null"
    [progressPercent]="(readingProgress$ | async) ?? null"
    (close)="togglePanel()"
    (settingsChange)="onSettingsChange($event)"
    (chapterSelect)="onChapterSelect($event)"
    (bookmarkJump)="jumpToBookmark($event)"
    (bookmarkRemove)="removeBookmark($event)">
  </app-unified-settings-panel>

  <div #viewer class="epub-viewer" (click)="onViewerClick()"></div>
  
  <!-- Top bar: navigation + settings toggle -->
  <div class="reader-controls" [class.hidden-in-focus]="focusMode()" [class.focus-temporary-show]="focusModeControlsVisible()">
    <button
      class="bookmark-toggle"
      (click)="toggleBookmarkAtCurrentLocation()"
      [class.bookmarked]="isCurrentLocationBookmarked()"
      [attr.aria-label]="isCurrentLocationBookmarked() ? 'Remove bookmark' : 'Add bookmark'"
      title="Toggle bookmark">
      {{ isCurrentLocationBookmarked() ? 'ğŸ”–' : 'ğŸ·ï¸' }}
    </button>

    <button (click)="prevPage()" [disabled]="!canGoPrev" aria-label="Previous page">Previous</button>
    <span
      class="page-info"
      (click)="togglePageInfo()"
      title="Click to toggle progress">
      @if (showProgress()) {
        {{ (readingProgress$ | async) ?? 0 }}% complete
      } @else {
        {{ currentLocation }}
      }
    </span>
    
    
    
    <button (click)="nextPage()" [disabled]="!canGoNext" aria-label="Next page">Next</button>

    @if (estimatedTimeRemaining$ | async; as eta) {
      <span class="eta-badge" title="Estimated time remaining">{{ eta }}</span>
    }

    <!-- Settings button is always visible, even in focus mode -->
    <button
      class="panel-toggle always-visible"
      (click)="togglePanel()"
      [attr.aria-expanded]="panelOpen()"
      aria-label="Open settings panel"
      title="Settings & More">
      âš™ï¸
    </button>
  </div>

  <!-- Follow mode indicator -->
  @if (followMode()) {
    <div class="follow-mode-indicator">
      <span>Follow Mode</span>
      <small>Use â†’ and â† keys, ESC to exit</small>
    </div>
  }
</div>
