<div class="epub-container" [attr.data-theme]="theme()">
  <!-- Reading progress bar -->
  <div class="progress-bar-container" [attr.title]="'Reading progress: ' + (readingProgress$ | async) + '%'">
    <div class="progress-bar-fill" [style.width.%]="readingProgress$ | async"></div>
  </div>

  <!-- Top bar: navigation + settings toggle -->
  <div class="reader-controls">
    <button
      class="bookmark-toggle"
      (click)="toggleBookmarkAtCurrentLocation()"
      [class.bookmarked]="isCurrentLocationBookmarked()"
      [attr.aria-label]="isCurrentLocationBookmarked() ? 'Remove bookmark' : 'Add bookmark'"
      title="Toggle bookmark">
      {{ isCurrentLocationBookmarked() ? 'üîñ' : 'üè∑Ô∏è' }}
    </button>

    <button (click)="prevPage()" [disabled]="!canGoPrev" aria-label="Previous page">Previous</button>
    <span class="page-info">{{ currentLocation }}</span>
    <button (click)="nextPage()" [disabled]="!canGoNext" aria-label="Next page">Next</button>

    @if (estimatedTimeRemaining$ | async; as eta) {
      <span class="eta-badge" title="Estimated time remaining">{{ eta }}</span>
    }

    <button
      class="bookmarks-list-toggle"
      (click)="toggleBookmarksPanel()"
      [attr.aria-expanded]="bookmarksOpen()"
      aria-label="Bookmarks"
      title="Bookmarks">
      üìë
    </button>

    <button
      class="settings-toggle"
      (click)="toggleSettings()"
      [attr.aria-expanded]="settingsOpen()"
      aria-label="Reader settings"
      title="Reader settings">
      ‚öô
    </button>
  </div>

  <!-- Bookmarks panel -->
  @if (bookmarksOpen()) {
    <aside class="bookmarks-panel" role="dialog" aria-label="Bookmarks">
      <header class="bookmarks-header">
        <h3>üîñ Bookmarks</h3>
        <button class="close-btn" (click)="toggleBookmarksPanel()" aria-label="Close bookmarks">‚úï</button>
      </header>
      <div class="bookmarks-list">
        @if (bookmarks$ | async; as bookmarks) {
          @if (bookmarks.length === 0) {
            <p class="bookmarks-empty">No bookmarks yet. Tap üè∑Ô∏è to add one.</p>
          }
          @for (bm of bookmarks; track bm.id) {
            <div class="bookmark-item" (click)="jumpToBookmark(bm)" role="button" tabindex="0">
              <span class="bookmark-label">{{ bm.label }}</span>
              <span class="bookmark-date">{{ bm.createdAt | date: 'short' }}</span>
              <button
                class="bookmark-remove"
                (click)="removeBookmark(bm.id, $event)"
                aria-label="Remove bookmark"
                title="Remove">
                ‚úï
              </button>
            </div>
          }
        }
      </div>

      <!-- Reading stats summary -->
      @if (readingStats$ | async; as stats) {
        @if (stats.totalReadingTime > 0) {
          <div class="reading-stats-summary">
            <h4>üìä Reading Stats</h4>
            <div class="stats-grid">
              <div class="stat-item">
                <span class="stat-value">{{ formatDuration(stats.totalReadingTime) }}</span>
                <span class="stat-label">Total time</span>
              </div>
              <div class="stat-item">
                <span class="stat-value">{{ stats.sessions.length }}</span>
                <span class="stat-label">Sessions</span>
              </div>
              @if (todayReadingTime$ | async; as todayTime) {
                <div class="stat-item">
                  <span class="stat-value">{{ formatDuration(todayTime) }}</span>
                  <span class="stat-label">Today</span>
                </div>
              }
            </div>
          </div>
        }
      }

      <!-- Reading goal -->
      @if (readingGoal$ | async; as goal) {
        <div class="reading-goal-summary">
          <h4>üéØ Reading Goal</h4>
          <div class="goal-streak">
            <span class="streak-flame">üî•</span>
            <span class="streak-count">{{ goal.currentStreak }} day streak</span>
          </div>
        </div>
      }
    </aside>
  }

  <!-- Floating / draggable settings panel (no backdrop ‚Äî non-blocking) -->
  @if (settingsOpen()) {
    <aside
      class="settings-panel"
      role="dialog"
      aria-label="Reader settings"
      [style.left.px]="panelX()"
      [style.top.px]="panelY()"
      [class.positioned]="panelX() !== null">
      <!-- Drag handle -->
      <header
        class="settings-header"
        (mousedown)="onDragStart($event)"
        (touchstart)="onDragStart($event)">
        <span class="drag-grip" aria-hidden="true">‚†ø</span>
        <h3>Reader Settings</h3>
        <button class="close-btn" (click)="toggleSettings()" aria-label="Close settings">‚úï</button>
      </header>

      <!-- Presets -->
      <div class="settings-section presets-section">
        <span class="section-label">Quick Presets</span>
        <div class="preset-buttons">
          @for (preset of presets; track preset.label) {
            <button
              class="preset-btn"
              (click)="applyPreset(preset)"
              [attr.aria-label]="preset.label + ' preset'">
              <span class="preset-icon">{{ preset.icon }}</span>
              {{ preset.label }}
            </button>
          }
        </div>
      </div>

      <!-- Font Size slider -->
      <div class="settings-section">
        <div class="slider-header">
          <span class="section-label">Font Size</span>
          <span class="slider-value">{{ fontSize() }}px</span>
        </div>
        <input
          type="range"
          class="settings-slider"
          [min]="FONT_SIZE_MIN"
          [max]="FONT_SIZE_MAX"
          [step]="FONT_SIZE_STEP"
          [value]="fontSize()"
          (input)="updateFontSize($event)"
          aria-label="Font size" />
        <div class="slider-range-labels">
          <span>{{ FONT_SIZE_MIN }}px</span>
          <span>{{ FONT_SIZE_MAX }}px</span>
        </div>
      </div>

      <!-- Margin slider -->
      <div class="settings-section">
        <div class="slider-header">
          <span class="section-label">Margin</span>
          <span class="slider-value">{{ margin() }}px</span>
        </div>
        <input
          type="range"
          class="settings-slider"
          [min]="MARGIN_MIN"
          [max]="MARGIN_MAX"
          [step]="MARGIN_STEP"
          [value]="margin()"
          (input)="updateMargin($event)"
          aria-label="Margin" />
        <div class="slider-range-labels">
          <span>{{ MARGIN_MIN }}px</span>
          <span>{{ MARGIN_MAX }}px</span>
        </div>
      </div>

      <!-- Line Height slider -->
      <div class="settings-section">
        <div class="slider-header">
          <span class="section-label">Line Height</span>
          <span class="slider-value">{{ lineHeight() }}</span>
        </div>
        <input
          type="range"
          class="settings-slider"
          [min]="LINE_HEIGHT_MIN"
          [max]="LINE_HEIGHT_MAX"
          [step]="LINE_HEIGHT_STEP"
          [value]="lineHeight()"
          (input)="updateLineHeight($event)"
          aria-label="Line height" />
        <div class="slider-range-labels">
          <span>{{ LINE_HEIGHT_MIN }}</span>
          <span>{{ LINE_HEIGHT_MAX }}</span>
        </div>
      </div>

      <!-- Theme -->
      <div class="settings-section">
        <span class="section-label">Theme</span>
        <div class="theme-buttons" role="radiogroup" aria-label="Reader theme">
          @for (opt of themeOptions; track opt.value) {
            <button
              class="theme-btn theme-btn--{{ opt.value }}"
              [class.selected]="theme() === opt.value"
              (click)="updateTheme(opt.value)"
              [attr.aria-pressed]="theme() === opt.value"
              [attr.aria-label]="opt.label + ' theme'">
              {{ opt.label }}
            </button>
          }
        </div>
      </div>

      <!-- Reset -->
      <div class="settings-section reset-section">
        <button class="reset-btn" (click)="resetToDefaults()" aria-label="Reset to default settings">
          ‚Ü∫ Reset to Defaults
        </button>
      </div>
    </aside>
  }

  <div #viewer class="epub-viewer"></div>
</div>
