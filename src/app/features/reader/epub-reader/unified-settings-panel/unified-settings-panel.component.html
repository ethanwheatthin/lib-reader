@if (isOpen) {
  <!-- Backdrop overlay -->
  <div 
    class="backdrop" 
    (click)="closePanel()" 
    (touchend)="closePanel()"
    (mousedown)="$event.stopPropagation()"
    (touchstart)="$event.stopPropagation()">
  </div>
  
  <aside
    class="unified-panel"
    role="dialog"
    aria-label="Reader settings panel"
    [attr.data-theme]="theme"
    [style.left.px]="panelX()"
    [style.top.px]="panelY()"
    [class.positioned]="panelX() !== null"
    (click)="$event.stopPropagation()"
    (touchstart)="$event.stopPropagation()">
    
    <!-- Drag handle header -->
    <header
      class="panel-header"
      (mousedown)="onDragStart($event)"
      (touchstart)="onDragStart($event)">
      <span class="drag-grip" aria-hidden="true">‚†ø</span>
      <h3>Reader Controls</h3>
      <button class="close-btn" (click)="closePanel()" aria-label="Close panel">‚úï</button>
    </header>

    <!-- Tab navigation -->
    <nav class="tab-nav" role="tablist">
      <button
        class="tab-button"
        [class.active]="activeTab() === 'settings'"
        (click)="switchTab('settings')"
        role="tab"
        [attr.aria-selected]="activeTab() === 'settings'"
        aria-label="Reader settings">
        ‚öôÔ∏è Settings
      </button>
      <button
        class="tab-button"
        [class.active]="activeTab() === 'chapters'"
        (click)="switchTab('chapters')"
        role="tab"
        [attr.aria-selected]="activeTab() === 'chapters'"
        aria-label="Table of contents">
        üìñ Chapters
      </button>
      <button
        class="tab-button"
        [class.active]="activeTab() === 'bookmarks'"
        (click)="switchTab('bookmarks')"
        role="tab"
        [attr.aria-selected]="activeTab() === 'bookmarks'"
        aria-label="Bookmarks and progress">
        üîñ Bookmarks
      </button>
    </nav>

    <!-- Tab content -->
    <div class="tab-content">
      
      <!-- SETTINGS TAB -->
      @if (activeTab() === 'settings') {
        <div class="settings-tab" role="tabpanel">
          
          <!-- Font Family -->
          <div class="settings-section">
            <span class="section-label">Font</span>
            <div class="font-buttons">
              @for (font of fonts; track font) {
                <button
                  class="font-btn"
                  [class.selected]="settings.fontFamily === font"
                  [style.font-family]="font"
                  (click)="updateFontFamily(font)"
                  [attr.aria-pressed]="settings.fontFamily === font"
                  [attr.aria-label]="font + ' font'">
                  {{ font }}
                </button>
              }
            </div>
          </div>

          <!-- Font Size -->
          <div class="settings-section">
            <div class="control-header">
              <span class="section-label">Font Size</span>
              <div class="control-buttons">
                <button
                  class="control-btn"
                  (click)="decreaseFontSize()"
                  [disabled]="settings.fontSize <= FONT_SIZE_MIN"
                  aria-label="Decrease font size">
                  ‚àí
                </button>
                <span class="control-value">{{ settings.fontSize }}px</span>
                <button
                  class="control-btn"
                  (click)="increaseFontSize()"
                  aria-label="Increase font size">
                  +
                </button>
              </div>
            </div>
          </div>

          <!-- Line Height -->
          <div class="settings-section">
            <div class="control-header">
              <span class="section-label">Line Height</span>
              <div class="control-buttons">
                <button
                  class="control-btn"
                  (click)="decreaseLineHeight()"
                  [disabled]="settings.lineHeight <= LINE_HEIGHT_MIN"
                  aria-label="Decrease line height">
                  ‚àí
                </button>
                <span class="control-value">{{ settings.lineHeight }}</span>
                <button
                  class="control-btn"
                  (click)="increaseLineHeight()"
                  aria-label="Increase line height">
                  +
                </button>
              </div>
            </div>
          </div>

          <!-- Theme -->
          <div class="settings-section">
            <span class="section-label">Theme</span>
            <div class="theme-buttons" role="radiogroup" aria-label="Reader theme">
              @for (opt of themeOptions; track opt.value) {
                <button
                  class="theme-btn theme-btn--{{ opt.value }}"
                  [class.selected]="settings.theme === opt.value"
                  (click)="updateTheme(opt.value)"
                  [attr.aria-pressed]="settings.theme === opt.value"
                  [attr.aria-label]="opt.label + ' theme'">
                  {{ opt.label }}
                </button>
              }
            </div>
          </div>

          <!-- Reading Modes Section -->
          <div class="settings-divider"></div>
          
          <!-- Flow Mode (Paginated vs Scroll) -->
          <div class="settings-section">
            <span class="section-label">Reading Mode</span>
            <div class="mode-buttons" role="radiogroup" aria-label="Reading flow mode">
              <button
                class="mode-btn"
                [class.selected]="settings.flowMode === 'paginated'"
                (click)="updateFlowMode('paginated')"
                [attr.aria-pressed]="settings.flowMode === 'paginated'"
                aria-label="Paginated mode">
                üìÑ Paginated
              </button>
              <button
                class="mode-btn"
                [class.selected]="settings.flowMode === 'scrolled'"
                (click)="updateFlowMode('scrolled')"
                [attr.aria-pressed]="settings.flowMode === 'scrolled'"
                aria-label="Scroll mode">
                üìú Scroll
              </button>
            </div>
          </div>

          <!-- Zoom Level -->
          <div class="settings-section">
            <span class="section-label">Zoom</span>
            <div class="zoom-dropdown-wrapper">
              <button
                class="zoom-dropdown-trigger"
                (click)="toggleZoomDropdown()"
                [attr.aria-expanded]="zoomDropdownOpen()"
                aria-haspopup="listbox"
                aria-label="Select zoom level">
                <span>{{ currentZoomLabel }}</span>
                <span class="zoom-dropdown-arrow" [class.open]="zoomDropdownOpen()">‚ñæ</span>
              </button>
              @if (zoomDropdownOpen()) {
                <ul class="zoom-dropdown-menu" role="listbox" aria-label="Zoom level options">
                  @for (opt of zoomOptions; track opt.value) {
                    <li
                      class="zoom-dropdown-item"
                      [class.selected]="settings.zoomLevel === opt.value"
                      (click)="selectZoomLevel(opt.value)"
                      role="option"
                      [attr.aria-selected]="settings.zoomLevel === opt.value">
                      <span>{{ opt.label }}</span>
                      @if (settings.zoomLevel === opt.value) {
                        <span class="zoom-check">‚úì</span>
                      }
                    </li>
                  }
                </ul>
              }
            </div>
          </div>

          <!-- Page Layout (icon buttons) -->
          <div class="settings-section">
            <span class="section-label">Page Layout</span>
            <div class="page-layout-buttons" role="radiogroup" aria-label="Page layout mode">
              @for (opt of pageLayoutOptions; track opt.value) {
                <button
                  class="page-layout-btn"
                  [class.selected]="settings.pageLayout === opt.value"
                  (click)="updatePageLayout(opt.value)"
                  [attr.aria-pressed]="settings.pageLayout === opt.value"
                  [attr.aria-label]="opt.label + ' layout'"
                  [title]="opt.label">
                  @if (opt.icon === 'auto') {
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor" aria-hidden="true">
                      <rect x="3" y="3" width="18" height="18" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
                      <text x="12" y="16" text-anchor="middle" font-size="11" font-weight="bold" fill="currentColor">A</text>
                    </svg>
                  }
                  @if (opt.icon === 'two-page') {
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor" aria-hidden="true">
                      <rect x="2" y="3" width="9" height="18" rx="1" fill="none" stroke="currentColor" stroke-width="2"/>
                      <rect x="13" y="3" width="9" height="18" rx="1" fill="none" stroke="currentColor" stroke-width="2"/>
                      <line x1="5" y1="7" x2="8" y2="7" stroke="currentColor" stroke-width="1.5"/>
                      <line x1="5" y1="10" x2="8" y2="10" stroke="currentColor" stroke-width="1.5"/>
                      <line x1="5" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="1.5"/>
                      <line x1="16" y1="7" x2="19" y2="7" stroke="currentColor" stroke-width="1.5"/>
                      <line x1="16" y1="10" x2="19" y2="10" stroke="currentColor" stroke-width="1.5"/>
                      <line x1="16" y1="13" x2="19" y2="13" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                  }
                  @if (opt.icon === 'one-page') {
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor" aria-hidden="true">
                      <rect x="5" y="3" width="14" height="18" rx="1" fill="none" stroke="currentColor" stroke-width="2"/>
                      <line x1="8" y1="7" x2="16" y2="7" stroke="currentColor" stroke-width="1.5"/>
                      <line x1="8" y1="10" x2="16" y2="10" stroke="currentColor" stroke-width="1.5"/>
                      <line x1="8" y1="13" x2="16" y2="13" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                  }
                </button>
              }
            </div>
          </div>

          <!-- Toggle Modes -->
          <div class="settings-section">
            <span class="section-label">View Options</span>
            <div class="toggle-options">
              <button
                class="toggle-btn"
                [class.active]="settings.focusMode"
                (click)="toggleFocusMode()"
                [attr.aria-pressed]="settings.focusMode"
                title="Hide controls for distraction-free reading (press F to toggle)">
                <span class="toggle-icon">{{ settings.focusMode ? '‚úì' : '' }}</span>
                <span class="toggle-label">Focus Mode</span>
                <span class="toggle-hint">F</span>
              </button>
              <!-- <button
                class="toggle-btn"
                [class.active]="settings.followMode"
                (click)="toggleFollowMode()"
                [attr.aria-pressed]="settings.followMode"
                title="Highlight and follow text word by word (auto-advances)">
                <span class="toggle-icon">{{ settings.followMode ? '‚úì' : '' }}</span>
                <span class="toggle-label">Follow Mode</span>
                <span class="toggle-hint">‚Üí ‚Üê</span>
              </button> -->
            </div>
          </div>

          <!-- Follow Mode Speed (only shown when follow mode is active) -->
          @if (settings.followMode) {
            <div class="settings-section follow-speed-section">
              <div class="control-header">
                <span class="section-label">Reading Speed</span>
                <div class="control-buttons">
                  <button
                    class="control-btn"
                    (click)="decreaseFollowSpeed()"
                    [disabled]="settings.followModeSpeed <= FOLLOW_MODE_SPEED_MIN"
                    aria-label="Decrease reading speed">
                    ‚àí
                  </button>
                  <span class="control-value">{{ settings.followModeSpeed }} WPM</span>
                  <button
                    class="control-btn"
                    (click)="increaseFollowSpeed()"
                    [disabled]="settings.followModeSpeed >= FOLLOW_MODE_SPEED_MAX"
                    aria-label="Increase reading speed">
                    +
                  </button>
                </div>
              </div>
              <p class="speed-hint">Words per minute (100-600)</p>
            </div>
          }

        </div>
      }

      <!-- CHAPTERS TAB -->
      @if (activeTab() === 'chapters') {
        <div class="chapters-tab" role="tabpanel">
          <nav class="chapters-list" role="navigation">
            @if (chapters.length === 0) {
              <p class="empty-message">No table of contents available</p>
            }
            @for (chapter of chapters; track chapter.id) {
              <div class="chapter-group">
                <button
                  class="chapter-item"
                  [class.current]="currentChapter === chapter.href"
                  (click)="onChapterClick(chapter)"
                  [attr.aria-current]="currentChapter === chapter.href ? 'true' : null">
                  <span class="chapter-label">{{ chapter.label }}</span>
                </button>
                @if (chapter.subitems && chapter.subitems.length > 0) {
                  <div class="chapter-subitems">
                    @for (subchapter of chapter.subitems; track subchapter.id) {
                      <button
                        class="chapter-item chapter-item--sub"
                        [class.current]="currentChapter === subchapter.href"
                        (click)="onChapterClick(subchapter)"
                        [attr.aria-current]="currentChapter === subchapter.href ? 'true' : null">
                        <span class="chapter-label">{{ subchapter.label }}</span>
                      </button>
                    }
                  </div>
                }
              </div>
            }
          </nav>
        </div>
      }

      <!-- BOOKMARKS TAB -->
      @if (activeTab() === 'bookmarks') {
        <div class="bookmarks-tab" role="tabpanel">
          
          <!-- Bookmarks list -->
          <div class="bookmarks-section">
            <h4 class="section-title">üîñ Your Bookmarks</h4>
            <div class="bookmarks-list">
              @if (bookmarks.length === 0) {
                <p class="empty-message">No bookmarks yet. Tap üè∑Ô∏è to add one.</p>
              }
              @for (bm of bookmarks; track bm.id) {
                <div class="bookmark-item" (click)="onBookmarkClick(bm)" role="button" tabindex="0">
                  <span class="bookmark-label">{{ bm.label }}</span>
                  <span class="bookmark-date">{{ bm.createdAt | date: 'short' }}</span>
                  <button
                    class="bookmark-remove"
                    (click)="onBookmarkRemove(bm.id, $event)"
                    aria-label="Remove bookmark"
                    title="Remove">
                    ‚úï
                  </button>
                </div>
              }
            </div>
          </div>

          <!-- Reading progress -->
          @if (progressPercent !== null && progressPercent >= 0) {
            <div class="reading-progress-section">
              <h4 class="section-title">üìà Book Progress</h4>
              <div class="progress-overview">
                <div class="progress-bar-track">
                  <div class="progress-bar-fill" [style.width.%]="progressPercent"></div>
                </div>
                <span class="progress-text">{{ progressPercent }}% complete</span>
              </div>
            </div>
          }

          <!-- Reading stats -->
          @if (readingStats && readingStats.totalReadingTime > 0) {
            <div class="reading-stats-section">
              <h4 class="section-title">üìä Reading Stats</h4>
              <div class="stats-grid">
                <div class="stat-item">
                  <span class="stat-value">{{ formatDuration(readingStats.totalReadingTime) }}</span>
                  <span class="stat-label">Total time</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">{{ readingStats.sessions.length }}</span>
                  <span class="stat-label">Sessions</span>
                </div>
                @if (todayReadingTime !== null) {
                  <div class="stat-item">
                    <span class="stat-value">{{ formatDuration(todayReadingTime) }}</span>
                    <span class="stat-label">Today</span>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Reading goal -->
          @if (readingGoal) {
            <div class="reading-goal-section">
              <h4 class="section-title">üéØ Reading Goal</h4>
              <div class="goal-streak">
                <span class="streak-flame">üî•</span>
                <span class="streak-count">{{ readingGoal.currentStreak }} day streak</span>
              </div>
            </div>
          }

        </div>
      }

    </div>
  </aside>
}
